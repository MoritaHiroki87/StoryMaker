
{% load staticfiles %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <title>project</title>
    <link rel="stylesheet" href="{% static 'board/project.css' %}" />
</head>
<body>
<div class="project-area">
    <p>project_name: {{ project.project_name }}</p>
    <a href="{% url 'board:project_list' %}">プロジェクト切り替え</a>
</div>

<br />

<div class="card-board-area">
    <div class="curtain-container">
        {% for curtain in project.curtain_list %}
            <div class="curtain-area">
                <p>{{ curtain.curtain_name }}</p>
                <p><a class="curtain-edit-btn" href="{% url 'board:edit_curtain' project_id=project.project_id curtain_id=curtain.curtain_id %}">編集</a></p>
                <p>-----------</p>
                <div class="card-container">
                    {% for card in curtain.card_list %}
                        <p class="card-name">{{ card.card_name }}</p>
                        <p><a class="card-edit-btn" href="{% url 'board:edit_card' project_id=project.project_id curtain_id=curtain.curtain_id card_id=card.card_id %}">編集</a></p>
                    {% endfor %}
                    <p>------------</p>
                    <p><a class="card-create-btn" href="{% url 'board:create_card' project_id=project.project_id curtain_id=curtain.curtain_id %}">カードの作成</a></p>
                    <!-- ここにカードタイトルと登録ボタンを配置する -->
                    <div id="app">
                    <!-- ヘッダーナビゲーション -->

                    <!-- メッセージエリア -->
                        <div id="message">
                            <p v-show="message.error">
                                #{ message.error }
                            </p>
                            <div v-show="message.warnings.length">
                                <p v-for="warning in message.warnings">
                                    #{ warning }
                                </p>
                            </div>
                            <p v-show="message.info">
                                #{ message.info }
                            </p>
                        </div>
                        <!-- メインエリア -->
                        <div id="main-page">
                            <form @submit.prevent="submitSave">
                                <label>タイトル</label>
                                <input type="text" v-model="form.card.card_name">
                                <label>詳細</label>
                                <input type="text" v-model="form.card.card_detail">
                                <button type="submit" variant="primary">#{ isCreated ? '更新' : '登録'}</button>
                            </form>
                        </div>

                        <!-- デバッグ -->
                        <div id="debug">
                            <div>
                                <pre>#{ $data }</pre> <!-- $dataはVueプロパティ -->
                            </div>
                        </div>
                    </div>
                    <!-- 終わり -->
                </div>
            </div>
        {% endfor %}

            <div class="curtain-area">
                <a class="curtain-create-btn" href="{% url 'board:create_curtain' project.project_id %}">幕の作成</a>
            </div>
    </div>
</div>

<!-- Vuew.js, axios -->
<script></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // CSRFトークンの送信設定
    axios.defaults.xsrfCookieName = 'csrftoken'
    axios.defaults.xsrfHeaderName = 'X-CSRFToken'

    // APIクライアント
    const api = axios.create({
        baseURL: 'api/v1/',
        timeout: 5000,
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })

    // Mustache構文のバッティングを回避
    new Vue({
        delimiters: ['#{', '}']
    })

    // Vueインスタンスの生成
    const app = new Vue({
        el: '#app',
        data: {
            form: {
                card: {
                    card_name: '',
                    card_detail: '',
                }
            },
            message: {
                info: '',
                warnings: [],
                error: ''
            }
        },
        computed: {
            isCreated: function(){
                return this.form.card.id !== undefined
            }
        },
        methods: {
            // 登録・更新ボタンの押下時に呼び出されるメソッド
            submitSave: function(){
                this.clearMessages()
                api({
                    // 登録済みかどうかでHTTPメソッドとエンドポイントを切り替える
                    method: this.isCreated ? 'put' : 'post',
                    url: this.isCreated() ? '/cards/' + this.form.card.id + '/' : '/cards/',
                    data: {
                        'id': this.form.card.id,
                        'card_name': this.form.card.card_name,
                        'card_detail': this.form.card.card_detail
                    }
                })
                    .then(response => {
                        this.message.info = this.isCreated() ? '更新しました。' : '登録しました。'
                        this.form.card = response.data
                    })
                    .catch(error => {
                        const status = error.response ? error.response.status : 500
                        if (status === 400) {
                            // バリデーションNG
                            this.message.warnings = [].concat.apply(
                                [], Object.values(error.response.data))
                        } else if (status === 401) {
                            this.message.error = '認証エラー'
                        } else if (status === 403) {
                            this.message.error = '権限エラー'
                        } else {
                            this.message.error = '想定外のエラー'
                        }
                    })
            },
            // メッセージをクリア
            clearMessages: function () {
                this.message.error = ''
                this.message.warnings = []
                this.message.info = ''
            }
        }
    })
</script>
</body>
</html>